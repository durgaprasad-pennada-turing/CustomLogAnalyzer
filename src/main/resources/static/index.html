<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Stage Log Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar { width: 6px; }
        textarea::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 3px; }
        textarea::-webkit-scrollbar-track { background-color: #f1f5f9; }

        /* Use Inter font */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    </style>
    <script>
        // Use a simple map to store results grouped by log source for better display
        let groupedResults = {};

        /**
         * Runs the analysis by collecting data from all six inputs and sending it to the backend.
         */
        async function runAnalysis() {
            const resultDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status-message');
            
            // Clear previous results and show loading status
            resultDiv.innerHTML = '';
            groupedResults = {};
            statusDiv.textContent = 'Running analysis...';
            statusDiv.classList.remove('text-red-600', 'text-green-600');
            statusDiv.classList.add('text-indigo-600');
            document.getElementById('analysis-button').disabled = true;

            const requestBody = {
                // Collect all 4 log inputs
                baseLog: document.getElementById('base_log').value,
                beforeLog: document.getElementById('before_log').value,
                afterLog: document.getElementById('after_log').value,
                postAgentPatchLog: document.getElementById('post_agent_patch_log').value,
                
                // Collect all 2 test list inputs
                mainJsonTests: document.getElementById('main_json_tests').value,
                reportJsonTests: document.getElementById('report_json_tests').value,
            };

            try {
                // Use exponential backoff for a robust API call
                const maxRetries = 3;
                let response;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch('/api/analysis/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        break;
                    }

                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Request failed. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Failed to fetch results after ${maxRetries} attempts.`);
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }

                const results = await response.json();
                
                statusDiv.textContent = `Analysis complete. Found ${results.length} total results.`;
                statusDiv.classList.remove('text-indigo-600');
                statusDiv.classList.add('text-green-600');

                displayResults(results);

            } catch (error) {
                console.error("Analysis failed:", error);
                statusDiv.textContent = `Analysis failed: ${error.message}`;
                statusDiv.classList.remove('text-indigo-600');
                statusDiv.classList.add('text-red-600');
            } finally {
                document.getElementById('analysis-button').disabled = false;
            }
        }

        /**
         * Displays the results, grouping them by log source for clarity.
         */
        function displayResults(results) {
            const resultDiv = document.getElementById('results');
            resultDiv.innerHTML = ''; // Clear existing content

            // Group results by logSource (e.g., "base_log", "before_log")
            results.forEach(result => {
                const source = result.logSource;
                if (!groupedResults[source]) {
                    groupedResults[source] = [];
                }
                groupedResults[source].push(result);
            });

            // Map keys (logSource) to display titles
            const sourceTitles = {
                "base_log": "Base Log Analysis",
                "before_log": "Before Log Analysis",
                "after_log": "After Log Analysis",
                "post_agent_patch_log": "Post Agent Patch Log Analysis",
                "N/A": "System Error"
            };

            // Order the display based on the defined order
            const orderedSources = ["base_log", "before_log", "after_log", "post_agent_patch_log", "N/A"];

            orderedSources.forEach(source => {
                const resultsForSource = groupedResults[source];

                if (resultsForSource && resultsForSource.length > 0) {
                    // Create section header
                    const header = document.createElement('h3');
                    header.className = 'text-lg font-bold mt-6 mb-2 border-b-2 border-indigo-200 pb-1 text-indigo-700';
                    header.textContent = sourceTitles[source] || source;
                    resultDiv.appendChild(header);

                    // Create list for results
                    const ul = document.createElement('ul');
                    ul.className = 'space-y-1';
                    
                    resultsForSource.forEach(result => {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-lg text-sm transition duration-150 ease-in-out flex justify-between items-center';

                        const isOk = result.result === 'Found';
                        const isError = result.result === 'Error';

                        let statusText = result.summary;
                        let statusClass = 'bg-gray-100 text-gray-800';

                        if (isOk) {
                            statusClass = 'bg-green-100 text-green-800 font-medium';
                        } else if (isError) {
                            statusClass = 'bg-red-200 text-red-900 font-bold';
                        } else {
                            // NOT OK (NotFound)
                            statusClass = 'bg-yellow-100 text-yellow-800 font-medium';
                        }
                        
                        li.className += ' ' + statusClass;
                        li.textContent = statusText;

                        ul.appendChild(li);
                    });

                    resultDiv.appendChild(ul);
                }
            });
        }
        
        // Populate placeholder content for demonstration
        window.onload = () => {
             document.getElementById('base_log').value = "Starting up service...\nFound TestA in base log\nSkipping TestD.";
             document.getElementById('before_log').value = "Service running.\nTestB started.\nTestC failed to execute.";
             document.getElementById('after_log').value = "Found TestA in after log\nTestB success.";
             document.getElementById('post_agent_patch_log').value = "Agent patch applied.\nFound ReportTestD\nAgent shutdown successful.";
             document.getElementById('main_json_tests').value = "TestA\nTestB\nTestC";
             document.getElementById('report_json_tests').value = "ReportTestD\nReportTestE";
        };

    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-2">Multi-Stage Log Analyzer</h1>
        <p class="text-gray-600 mb-8">
            Enter your four log files and two test lists below. The system will currently perform a **full cross-validation** (Issue 1) of all tests against all logs.
        </p>

        <!-- Input Section -->
        <div class="space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Log Contents (4 Files)</h2>
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Log File 1 -->
                <div class="col-span-1">
                    <label for="base_log" class="block text-sm font-medium text-gray-700 mb-1">Base Log</label>
                    <textarea id="base_log" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>

                <!-- Log File 2 -->
                <div class="col-span-1">
                    <label for="before_log" class="block text-sm font-medium text-gray-700 mb-1">Before Log</label>
                    <textarea id="before_log" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>

                <!-- Log File 3 -->
                <div class="col-span-1">
                    <label for="after_log" class="block text-sm font-medium text-gray-700 mb-1">After Log</label>
                    <textarea id="after_log" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>

                <!-- Log File 4 -->
                <div class="col-span-1">
                    <label for="post_agent_patch_log" class="block text-sm font-medium text-gray-700 mb-1">Post Agent Patch Log</label>
                    <textarea id="post_agent_patch_log" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 pt-4">Test Cases (2 Sets)</h2>
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Test Set 1 -->
                <div class="col-span-1">
                    <label for="main_json_tests" class="block text-sm font-medium text-gray-700 mb-1">Main JSON Tests (TestA, TestB, ...)</label>
                    <textarea id="main_json_tests" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Enter test names separated by newlines or commas."></textarea>
                </div>
                
                <!-- Test Set 2 -->
                <div class="col-span-1">
                    <label for="report_json_tests" class="block text-sm font-medium text-gray-700 mb-1">Report JSON Tests (TestD, TestE, ...)</label>
                    <textarea id="report_json_tests" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Enter test names separated by newlines or commas."></textarea>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="mt-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <button 
                id="analysis-button"
                onclick="runAnalysis()"
                class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]"
            >
                Run Analysis
            </button>
            <div id="status-message" class="mt-4 sm:mt-0 text-gray-500 font-medium">Ready to analyze.</div>
        </div>

        <!-- Results Section -->
        <div class="mt-12">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Analysis Results</h2>
            <div id="results" class="bg-gray-50 p-4 rounded-lg min-h-[100px] shadow-inner">
                <p class="text-gray-400 italic">Results will appear here after analysis.</p>
            </div>
        </div>
    </div>

</body>
</html>